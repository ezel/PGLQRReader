/**
 * MassClone - A simple tool to clone a box of Pokemon, written in C
 *
 * Save file structure and CRC-16 code are taken from PKHeX.
 * Memecrypto code are taken from SciresM's memecrypto_test.
 */

#include <stdio.h>

#include "qr.h"
#include "pokemon.h"

unsigned char* shiftArray(unsigned char* b);
void printRaw(unsigned char* p, int maxSize);
void printRawOct(unsigned char* r, int len);

unsigned char parseQR[] = {
  64,31,128,48,0,0,7,112,0,0,8,8,24,40,56,72,88,104,120,136,152,168,184,200,216,232,242,14,232,128,128,38,164,177,149,96,188,166,206,117,20,19,42,94,157,217,212,21,183,192,252,156,204,54,7,62,227,102,164,202,146,192,125,155,9,214,190,90,129,13,182,52,139,235,150,71,6,221,145,254,86,72,191,79,50,214,132,36,40,139,125,161,70,166,148,76,176,39,88,227,120,89,82,41,252,230,216,59,63,235,73,5,53,80,42,67,230,89,18,77,56,68,215,111,143,222,189,31,90,56,100,109,173,148,100,16,213,126,87,102,92,81,108,17,94,215,46,23,80,132,197,232,200,113,212,144,215,225,250,18,192,31,91,146,65,201,190,23,32,148,96,80,132,43,15,68,66,9,14,73,154,33,148,238,193,148,68,172,63,223,198,186,24,201,74,220,6,184,43,140,28,240,221,9,147,166,109,100,41,162,108,48,252,220,185,228,129,35,145,47,141,121,84,55,43,76,219,207,168,159,80,199,42,153,67,69,11,229,226,51,255,6,93,168,59,219,157,242,110,96,250,159,78,92,217,100,30,225,42,201,33,28,224,108,243,112,81,233,241,208,0,69,249,78,83,55,103,1,106,63,100,160,233,5,18,210,199,191,177,211,233,79,45,1,78,168,80,51,190,185,68,226,161,172,113,207,225,250,35,150,70,1,166,119,18,110,117,154,9,150,76,238,49,252,170,83,200,157,28,255,228,176,135,198,156,201,203,46,23,232,231,179,173,205,231,61,141,52,78,108,50,206,104,2,238,252,101,195,145,168,93,65,60,200,4,111,171,194,255,195,149,244,39,33,13,70,41,177,62,86,8,151,18,213,184,221,140,212,88,17,149,222,48,93,76,208,115,16,174,231,122,190,116,147,41,1,182,158,222,162,144,60,141,90,126,162,32,64,26,177,181,131,77,152,173,11,19,211,73,47,98,165,146,52,90,103,70,121,247,170,99,193,145,221,99,176,118,137,159,232,134,84,3,6,172,66,103,74,195,143,9,79,199,118,58,236,122,112,70,153,7,30,179,212,191,208,182,38,43,115,251,114,120,95,81,69,132,176,52,212,27,120,45,129,205,82,5,4,244,180,80,32,0,0,0,0,0};

unsigned char shift[]= {
  4,1,248,3,0,0,0,119,0,0,0,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,32,238,136,8,2,106,75,25,86,11,202,108,231,81,65,50,165,233,221,157,65,91,124,15,201,204,195,96,115,238,54,106,76,169,44,7,217,176,157,107,229,168,16,219,99,72,190,185,100,112,109,217,31,229,100,139,244,243,45,104,66,66,136,183,218,20,106,105,68,203,2,117,142,55,133,149,34,159,206,109,131,179,254,180,144,83,85,2,164,62,101,145,36,211,132,77,118,248,253,235,209,245,163,134,70,218,217,70,65,13,87,229,118,101,197,22,193,21,237,114,225,117,8,76,94,140,135,29,73,13,126,31,161,44,1,245,185,36,28,155,225,114,9,70,5,8,66,176,244,68,32,144,228,153,162,25,78,236,25,68,74,195,253,252,107,161,140,148,173,192,107,130,184,193,207,13,208,153,58,102,214,66,154,38,195,15,205,203,158,72,18,57,18,248,215,149,67,114,180,205,188,250,137,245,12,114,169,148,52,80,190,94,35,63,240,101,218,131,189,185,223,38,230,15,169,244,229,205,150,65,238,18,172,146,17,206,6,207,55,5,30,159,29,0,4,95,148,229,51,118,112,22,163,246,74,14,144,81,45,44,123,251,29,62,148,242,208,20,234,133,3,59,235,148,78,42,26,199,28,254,31,162,57,100,96,26,103,113,38,231,89,160,153,100,206,227,31,202,165,60,137,209,207,254,75,8,124,105,204,156,178,225,126,142,123,58,220,222,115,216,211,68,230,195,44,230,128,46,239,198,92,57,26,133,212,19,204,128,70,250,188,47,252,57,95,66,114,16,212,98,155,19,229,96,137,113,45,91,141,216,205,69,129,25,93,227,5,212,205,7,49,10,238,119,171,231,73,50,144,27,105,237,234,41,3,200,213,167,234,34,4,1,171,27,88,52,217,138,208,177,61,52,146,246,42,89,35,69,166,116,103,159,122,166,60,25,29,214,59,7,104,153,254,136,101,64,48,106,196,38,116,172,56,240,148,252,119,99,174,199,167,4,105,144,113,235,61,75,253,11,98,98,183,63,183,39,133,245,20,88,75,3,77,65,183,130,216,28,213,32,80,79,75,69,2,0,0,0,0,0};

unsigned char skip3[] = {
  3,0,0,0,119,0,0,0,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,32,238,136,8,2,106,75,25,86,11,202,108,231,81,65,50,165,233,221,157,65,91,124,15,201,204,195,96,115,238,54,106,76,169,44,7,217,176,157,107,229,168,16,219,99,72,190,185,100,112,109,217,31,229,100,139,244,243,45,104,66,66,136,183,218,20,106,105,68,203,2,117,142,55,133,149,34,159,206,109,131,179,254,180,144,83,85,2,164,62,101,145,36,211,132,77,118,248,253,235,209,245,163,134,70,218,217,70,65,13,87,229,118,101,197,22,193,21,237,114,225,117,8,76,94,140,135,29,73,13,126,31,161,44,1,245,185,36,28,155,225,114,9,70,5,8,66,176,244,68,32,144,228,153,162,25,78,236,25,68,74,195,253,252,107,161,140,148,173,192,107,130,184,193,207,13,208,153,58,102,214,66,154,38,195,15,205,203,158,72,18,57,18,248,215,149,67,114,180,205,188,250,137,245,12,114,169,148,52,80,190,94,35,63,240,101,218,131,189,185,223,38,230,15,169,244,229,205,150,65,238,18,172,146,17,206,6,207,55,5,30,159,29,0,4,95,148,229,51,118,112,22,163,246,74,14,144,81,45,44,123,251,29,62,148,242,208,20,234,133,3,59,235,148,78,42,26,199,28,254,31,162,57,100,96,26,103,113,38,231,89,160,153,100,206,227,31,202,165,60,137,209,207,254,75,8,124,105,204,156,178,225,126,142,123,58,220,222,115,216,211,68,230,195,44,230,128,46,239,198,92,57,26,133,212,19,204,128,70,250,188,47,252,57,95,66,114,16,212,98,155,19,229,96,137,113,45,91,141,216,205,69,129,25,93,227,5,212,205,7,49,10,238,119,171,231,73,50,144,27,105,237,234,41,3,200,213,167,234,34,4,1,171,27,88,52,217,138,208,177,61,52,146,246,42,89,35,69,166,116,103,159,122,166,60,25,29,214,59,7,104,153,254,136,101,64,48,106,196,38,116,172,56,240,148,252,119,99,174,199,167,4,105,144,113,235,61,75,253,11,98,98,183,63,183,39,133,245,20,88,75,3,77,65,183,130,216,28,213,32,80,79,75,69,2,0,0,0,0,0};

unsigned char pMemeCrypto[] ={
  3,0,0,0,119,0,0,0,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,32,238,136,8,2,106,75,25,86,11,202,108,231,81,65,50,165,233,221,157,65,91,124,15,201,204,195,96,115,238,54,106,76,169,44,7,217,176,157,107,229,168,16,219,99,72,190,185,100,112,109,217,31,229,100,139,244,243,45,104,66,66,136,183,218,20,106,105,68,203,2,117,142,55,133,149,34,159,206,109,131,179,254,180,144,83,85,2,164,62,101,145,36,211,132,77,118,248,253,235,209,245,163,134,70,218,217,70,65,13,87,229,118,101,197,22,193,21,237,114,225,117,8,76,94,140,135,29,73,13,126,31,161,44,1,245,185,36,28,155,225,114,9,70,5,8,66,176,244,68,32,144,228,153,162,25,78,236,25,68,74,195,253,252,107,161,140,148,173,192,107,130,184,193,207,13,208,153,58,102,214,66,154,38,195,15,205,203,158,72,18,57,18,248,215,149,67,114,180,205,188,250,137,245,12,114,169,148,52,80,190,94,35,63,240,101,218,131,189,185,223,38,230,15,169,244,229,205,150,65,238,18,172,146,17,206,6,207,55,5,30,159,29,0,4,95,148,229,51,118,112,22,163,246,74,14,144,81,45,44,123,251,29,62,148,242,208,20,234,133,3,59,235,148,78,42,26,199,28,254,31,162,57,100,96,26,103,113,38,231,89,160,153,100,206,227,31,202,165,60,137,209,207,254,75,8,124,105,204,156,178,225,126,142,123,58,220,222,115,216,211,68,230,195,44,230,128,46,239,198,92,57,26,133,212,19,204,128,70,250,188,47,252,57,95,66,114,16,212,98,155,19,229,96,137,113,45,91,141,216,205,69,129,25,93,227,5,212,205,7,49,10,238,119,253,10,26,163,72,96,129,233,28,143,199,222,129,151,96,226,193,186,120,252,166,211,172,176,27,47,50,141,208,30,50,4,202,150,196,180,155,64,243,174,55,43,57,161,113,67,146,108,55,71,114,112,180,205,69,176,16,43,140,38,224,167,33,106,18,254,125,38,159,155,211,91,17,225,127,82,195,125,104,124,46,204,50,37,66,83,52,248,163,42,147,81,232,33,9,155,80,79,75,69,2,0,0,0,0,0 };

unsigned char test21[] ={
  3,0,0,0,119,0,0,0,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,227,147,54,48,181,184,198,125,219,214,53,177,93,17,100,7,148,141,158,189,143,207,93,250,121,79,126,201,72,113,29,66,22,162,154,64,39,29,164,241,102,63,240,31,214,7,163,246,141,184,229,122,0,242,67,75,134,196,183,254,184,101,55,158,123,129,64,126,51,32,112,201,238,129,126,137,53,64,115,186,62,211,96,98,44,100,199,210,98,195,138,158,95,136,34,238,51,116,220,244,92,65,139,95,116,78,253,73,103,91,222,73,138,192,250,101,29,250,240,182,216,25,221,5,245,147,55,188,231,194,137,78,127,15,115,197,69,180,169,87,160,68,16,33,175,91,105,194,240,188,137,158,91,245,35,142,67,2,51,161,110,235,247,222,107,196,140,47,181,208,7,196,254,177,70,235,41,156,101,19,59,172,129,218,138,236,123,172,45,127,246,9,93,88,99,77,172,189,147,243,2,168,91,57,156,188,150,16,179,175,92,192,217,21,87,59,58,162,42,52,40,203,34,166,121,69,153,193,153,80,80,205,96,36,224,248,236,82,47,206,49,63,155,121,196,4,97,249,39,76,6,26,252,145,108,182,68,14,66,5,208,199,18,224,125,166,30,52,41,18,91,40,69,227,142,242,7,126,42,12,99,194,156,89,223,40,0,140,151,85,91,33,104,233,245,253,250,110,157,114,172,7,217,32,109,133,66,91,217,156,137,160,71,231,199,105,155,102,88,85,64,56,124,174,128,94,225,121,189,14,64,188,1,241,75,29,246,255,254,54,144,51,169,188,23,34,200,64,16,136,238,167,225,237,116,128,127,202,6,55,90,102,133,158,88,114,161,166,217,153,142,216,45,38,168,63,66,233,253,120,7,113,207,11,184,50,222,33,19,235,94,229,11,243,162,202,139,243,98,29,51,79,17,154,14,42,232,7,134,197,225,39,51,31,210,114,36,9,220,188,75,197,214,214,101,78,196,142,251,117,78,78,239,7,77,173,42,184,43,202,127,198,93,112,47,172,57,113,145,34,85,200,21,227,4,174,20,198,54,76,92,221,7,179,43,72,196,133,170,112,80,79,75,69,2,0,0,0,0,0
};
unsigned char test22[] ={
  3,0,0,0,119,0,0,0,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,227,147,54,48,181,184,198,125,219,214,53,177,93,17,100,7,148,141,158,189,143,207,93,250,121,79,126,201,72,113,29,66,22,162,154,64,39,29,164,241,102,63,240,31,214,7,163,246,141,184,229,122,0,242,67,75,134,196,183,254,184,101,55,158,123,129,64,126,51,32,112,201,238,129,126,137,53,64,115,186,62,211,96,98,44,100,199,210,98,195,138,158,95,136,34,238,51,116,220,244,92,65,139,95,116,78,253,73,103,91,222,73,138,192,250,101,29,250,240,182,216,25,221,5,245,147,55,188,231,194,137,78,127,15,115,197,69,180,169,87,160,68,16,33,175,91,105,194,240,188,137,158,91,245,35,142,67,2,51,161,110,235,247,222,107,196,140,47,181,208,7,196,254,177,70,235,41,156,101,19,59,172,129,218,138,236,123,172,45,127,246,9,93,88,99,77,172,189,147,243,2,168,91,57,156,188,150,16,179,175,92,192,217,21,87,59,58,162,42,52,40,203,34,166,121,69,153,193,153,80,80,205,96,36,224,248,236,82,47,206,49,63,155,121,196,4,97,249,39,76,6,26,252,145,108,182,68,14,66,5,208,199,18,224,125,166,30,52,41,18,91,40,69,227,142,242,7,126,42,12,99,194,156,89,223,40,0,140,151,85,91,33,104,233,245,253,250,110,157,114,172,7,217,32,109,133,66,91,217,156,137,160,71,231,199,105,155,102,88,85,64,56,124,174,128,94,225,121,189,14,64,188,1,241,75,29,246,255,254,54,144,51,169,188,23,34,200,64,16,136,238,167,225,237,116,128,127,202,6,55,90,102,133,158,88,114,161,166,217,153,142,216,45,38,206,133,145,136,196,210,130,213,117,88,158,193,63,94,21,15,84,72,134,51,59,208,193,128,207,136,37,20,237,53,180,237,212,193,21,223,235,176,191,72,211,80,142,111,199,170,47,86,146,156,212,57,26,142,110,71,112,47,191,154,240,215,253,92,149,218,54,61,32,60,109,148,235,92,72,235,43,90,161,164,13,184,16,5,173,194,9,36,0,0,209,203,117,206,46,27,80,79,75,69,2,0,0,0,0,0 };

int main(void){

  unsigned char* ptestdata = test21;
  qr_t* memedec_qr = memedecryptRawQR(ptestdata);

  int cmp_code = memcmp(memedec_qr, test22, 0x1EE);
  printf("code=%d\n", cmp_code);

  qr_dec_t* qr = decryptoQR(memedec_qr);
  //printRaw(memedec_qr, 496);
  pokemon* team = initListWithQR(qr);
  printf("--------\n");
  printTeam(team);

  free(team);
  free(qr);
  free(memedec_qr);
  return 0;
}

unsigned char* shiftArray(unsigned char* b) {
  unsigned char* array = malloc(507);
  unsigned char lb = 0;
  unsigned char rb = 0;
  for(int i=0;i<507;i++)
    {
      unsigned char B = b[i];
      lb = (B & 0xF0)>>4;
      array[i] = rb << 4 | lb;
      rb = B & 0xF;
    }

  return array;
}

void printRawOct(unsigned char* r, int len) {
  if (r) {
    for (int i=0; i<len; i++) {
      printf("%02X ", r[i]);
    }
    printf("\n");
  } else printf("null\n");
}

void printRaw(unsigned char* p, int maxSize) {
  for (int i = 0; i < 0x20; i++)
    {
      if (i*0x10 >= maxSize) break;
      for (int j = 0; j < 0x10; j++) {
        if (i*0x10+j >= maxSize) break;
        printf("%03d ", p[i*0x10+j]);
      }
      printf("\n");
    }
}
